Running Containers with Podman
===============================

::: notes

This is an elif TODO and everything in this notes tag goes into the speaker notes

:::


Searching for Images with `podman search`
---------------------------------------

### Configure search sources

```bash
grep search /etc/containers/registries.conf
```

```bash
unqualified-search-registries =
['registry.fedoraproject.org', 'registry.access.redhat.com',
'registry.centos.org', 'docker.io']
```

### Searching for images (with filters)

```bash
podman search httpd --filter=is-official
```

```bash
INDEX     NAME                    DESCRIPTION            STARS OFFICIAL
docker.io docker.io/library/httpd The Apache HTTP Server 3181  [OK]
```


::: notes

podman can be configured to search multiple private or public container registries for images.

:::


Adding a local registry configuration
-------------------------------------

### Create a configuration file

```bash
mkdir -p ~/.config/containers
```


### Add public and private registries in search order

```bash
vim $HOME/.config/containers/registries.conf
```


```
[registries.search]
registries = ["registry.access.redhat.com", "quay.io", "docker.io"]

[registries.insecure]
registries = ['localhost:5000']

[registries.blocked]
registries = []
```


Inspecting and pulling images
------------------------------

### Inspecting Images with `skopeo` (ex: listing tags)

```bash
skopeo inspect docker://docker.io/library/httpd
```


### Inspect the image with podman and show image history

```bash
podman inspect httpd:2.4.46-alpine
podman history httpd:2.4.46-alpine
```

### Pulling Images locally with `podman pull`

```bash
podman pull docker.io/library/httpd:2.4.46-alpine
podman images
```

::: notes

https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/managing_containers/finding_running_and_building_containers_with_podman_skopeo_and_buildah
Skopeo lets you inspect and copy images between registries.

:::


Running containers in interactive mode
--------------------------------------

### Run an interactive session

```bash
podman run --name ubuntu --hostname ubuntu \
	--interactive --tty ubuntu /bin/bash
```

### Reattach

```bash
podman start --attach --interactive ubuntu
```

### Delete your container on exit

```bash
podman run --rm --name ubuntu --hostname ubuntu \
	--interactive --tty ubuntu /bin/bash
```

::: notes

At this point, you could save your modified container and load it into a registry,
but there's a better way: build your container using a Dockerfile or buildah.

:::

Running Containers in the background
-------------------------------------

### Run a sample httpd container to serve a webpage

```bash
# Run a container in the background, bind port 8080
podman run --name httpd --detach \
	--publish 8080:8080/tcp \
	registry.fedoraproject.org/f29/httpd
```

- We've named the container `httpd` to make it easier to access later.
- Port 8080 inside the container is redirected to 8080 on the host.
- Notice that we're using an image that binds to a non-privileged (8080) port.


### Test the webpage

```bash
curl localhost:8080
```

### Check the process

```bash
ps -ef | grep podman
```


Check container status and logs
-------------------------------

### Check the container status and logs

```bash
# List the running containers
podman ps

# Inspect the (last) ran container - check the Env and IP sections
podman inspect -l

# Check the container logs
podman logs httpd
```

::: notes

The Env section is especially useful to identify env. variables used to start the container.

:::


Starting and stopping containers
-------------------------------

### Stop the container and check the status

```bash
podman stop httpd
podman ps -a
```

```bash
IMAGE         CREATED        STATUS
httpd:latest  5 minutes ago  Exited (0) 2 seconds ago
```

### Start the container back

```bash
podman start httpd
podman ps
CREATED       STATUS            PORTS                  NAMES
7 minutes ago Up 13 seconds ago 0.0.0.0:8080->8080/tcp httpd
```


Using Environment Variables
---------------------------

### Search and inspect an image
```bash
podman search mysql-57-rhel7
skopeo inspect \
  docker://registry.access.redhat.com/rhscl/mysql-57-rhel7 \
  | grep usage
```

### Deploy MySQL
```bash
podman run --name mysql \
  -e MYSQL_USER=user -e MYSQL_PASSWORD=password \
  -e MYSQL_DATABASE=mydb -e MYSQL_ROOT_PASSWORD=password \
  --detach rhscl/mysql-57-rhel7:latest
```

### Check the logs

```bash
podman logs mysql
```

Executing a command in a running container with podman-exec
--------------------------------------------------------

### Inspect the environment (different methods show)

```bash
podman inspect -f '{{ .NetworkSettings.IPAddress }}' mysql
podman exec mysql env
```

### Execute a shell inside the mysqld container

```bash
podman exec -it mysql bash
mysql -uroot
  show databases;
  use mydb;

exit
```

### Execute a command

```bash
podman exec -it mysql \
	/opt/rh/rh-mysql57/root/usr/bin/mysql \
	-uuser -ppassword -e 'show databases;'
```


::: notes

podman exec -it mysql /bin/bash
mysql -u root
show databases;

Note that rootless podman won't show an IPAddress https://podman.io/getting-started/network.html - run podman with sudo to obtain IP.

:::

Container Resources
-------------------

### Check processes inside container

```bash
podman top -l
```

```bash
USER      PID   PPID   %CPU    ELAPSED          TTY   TIME   COMMAND
default   1     0      0.000   2m4.13954806s    ?     0s     httpd -D FOREGROUND
default   18    1      0.000   2m4.139682033s   ?     0s     /usr/bin/coreutils
```

### Display live stream of resource usage statistics


```bash
podman stats
```

```bash
ID    NAME    CPU %   MEM USAGE / LIMIT  MEM %   NET IO   BLOCK IO  PIDS
00b65 httpd   0.07%   40.91MB / 67.4GB   0.06%   -- / --  -- / --   217
```

### Check published ports

```bash
podman port -l
```

```bash
8080/tcp -> 0.0.0.0:8080
```


Commiting, Saving and Loading Images
------------------------------------

### Create an image

```bash
podman run --name ubuntu-apache2 --hostname ubuntu-apache2  \
	--interactive --tty ubuntu:20.04 /bin/bash

# Install Apache HTTPD
apt update && apt install -y apache2 && exit
```

### List changed files (A - added, C - changed, D - deleted)

```bash
podman diff ubuntu-apache2
```

### Commit image from container with entrypoint and label

```bash
podman commit --change CMD=/bin/bash --change ENTRYPOINT=/bin/sh \
  --change "LABEL author=cmihai" ubuntu ubuntu-apache2
```

### Save an image

```bash
podman save -o ubuntu-apache2.tar ubuntu-apache2
```

### Load an image

```bash
podman load -i ubuntu-apache2.tar ubuntu-apache2
```

::: notes

podman commit creates an image based on a changed container.

:::


Modifying the Apache image port form 80 to 8080
------------------------------------------------

> Use podman commit to create a custom Apache HTTPD image that listens on port 8080.

### Search for the official image and run it

```bash
podman search httpd --filter=is-official
podman run -it --name httpd-docker docker.io/library/httpd:2.4 /bin/bash
```

### Change the port name

```bash
sed -i 's/Listen 80/Listen 8080/g' /usr/local/apache2/conf/httpd.conf
exit
```

### Same to a new image

```bash
podman stop httpd-docker
podman diff httpd-docker
podman commit -a 'Mihai' httpd-docker cmihai/httpd:2.4
podman images | grep cmihai/httpd
podman rm httpd-docker
```

### Test the new image

```bash
podman run --detach --publish 8080:8080 --name httpd-cmihai docker.io/library/httpd:2.4
curl localhost:8080
```

Tagging or Removing Tags from Images
--------------------------------------


### Tag and image

```bash
podman tag ubuntu-apache2 cmihai/apache2
podman tag ubuntu-apache2 cmihai/apache2:latest
```

### Remove a tag from an image

```bash
podman rmi cmihai/apache2:latest
```

::: notes

Multiple tags can point to the same image.

:::


Pusing an image to a Registry
-----------------------------

### Tag the image in your local repository

```bash
podman tag ubuntu-apache2 quay.io/apache2:latest
```

### Push to quay.io

```bash
podman push quay.io/cmihai/apache2:latest
```

### Example build and push

```
podman login quay.io
podman build --layers=false -t cmihai/jupyterlab:python38 .
podman tag localhost/cmihai/jupyterlab:python38 \
  quay.io/cmihai/jupyterlab:latest
podman push quay.io/cmihai/jupyterlab:latest
```

::: notes

Podman will automatically add the `latest` tag if you do not specify a tag!

:::


Volumes
-------

### Create a volume directory on the host and provide permissions

```bash
mkdir myvol
podman unshare chown 999:999 myvol
```

[https://www.redhat.com/sysadmin/user-namespaces-selinux-rootless-containers](https://www.redhat.com/sysadmin/user-namespaces-selinux-rootless-containers)

### Create a container and attach a volume to /data as rw

```bash
podman run --rm --name ubuntu \
	--volume ./myvol:/data:Z \
	--interactive --tty ubuntu /bin/bash
```

::: notes

- `-Z` tells podman to relabel the volume's content to match the label inside the container
- `podman unshare` runs a command inside a modified user namespace.

:::


SELinux Permissions - Manual approach without using unshare
-----------------------------------------------------------

### Let's check what a MySQL container runs as

```bash
podman run -ti rhscl/mysql-57-rhel7:latest grep mysql /etc/passwd
```

```bash
mysql:x:27:27:MySQL Server:/var/lib/mysql:/sbin/nologin
```

### Create a directory with owner and group root and give matching permissions

```bash
sudo mkdir mysql-data && sudo chown -R 27:27 mysql-data
```

### Apply the SELinux `container_file_t` context and policy

```bash
sudo semanage fcontext -a -t container_file_t './mysql-data(/.*)?'
sudo restorecon -Rv ./mysql-data
```


Running MySQL with a host directory volume
------------------------------------------

### Start MySQL

```bash
podman run --name mysql \
  -v ./mysql-data:/var/lib/mysql/data:Z \
  -e MYSQL_USER=user -e MYSQL_PASSWORD=password \
  -e MYSQL_DATABASE=mydb -e MYSQL_ROOT_PASSWORD=password \
  --detach rhscl/mysql-57-rhel7:latest
```

### Troubleshoot logs and permissions

```bash
podman logs mysql; sudo find ./mysql-data; ls -dnZ mysql-data
```

```bash
drwxrwxr-x. 6 100026 100026 system_u:object_r:container_file_t:s0:c303,c890
4096 Sep 27 09:09 mysql-data
```

### Check out the permissions inside the container

```bash
podman exec mysql ls -lanZ /var/lib/mysql/data
```

```
drwxrwxr-x. 27 27 system_u:object_r:container_file_t:s0:c303,c890 .
```

::: notes

# You could just use:

```
mkdir mysql-data
podman unshare chown 27:27 mysql-data
ls -dZ mysql-data

system_u:object_r:container_file_t:s0:c303,c890 mysql-data
```

:::


Cleanup
-------

### Stop and remove the container

```bash
podman stop httpd
podman rm httpd
podman ps -a 		# Check that the containers are deleted
```

### Removing the container image

```bash
podman rmi registry.fedoraproject.org/f29/httpd
podman images 		# List images
```

### Delete everything (stopped containers, pods, dangling images and build cache)

```bash
podman system prune
```

Setting a container to start at boot using systemd
---------------------------------------------------

### Enable SELinux and start your container

```bash
setsebool -P container_manage_cgroup on
sudo podman run -d --name redis_server -p 6379:6379 redis
```

### `vim /etc/systemd/system/redis-container.service`

```ini
[Unit]
Description=Redis container

[Service]
Restart=always
ExecStart=/usr/bin/podman start -a redis_server
ExecStop=/usr/bin/podman stop -t 2 redis_server

[Install]
WantedBy=local.target
```

### Enable the service

```bash
systemctl enable redis-container.service
systemctl start redis-container.service
systemctl stop redis-container.service
systemctl restart redis-container.service
systemctl status redis-container.service

```

::: notes

https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/managing_containers/running_containers_as_systemd_services_with_podman

:::

Creating a Wordpress + MariaDB Server pod
-----------------------------------------

### Create a volume and apply permissions

```bash
mkdir mariadb-data && podman unshare chown 999:999 mariadb-data
```

### Create a pod

```bash
podman pod create --publish 127.0.0.1:8888:80 --name wordpress-pod
```

### Start a pod to get info

```bash
podman run --rm mariadb:latest --verbose --help
```

### Start MariaDB with a custom configuration and data volume

```bash
podman run --name mariadb --pod wordpress-pod \
  -v ./mariadb-data:/var/lib/mysql:Z \
  -e MYSQL_USER=wpsuser -e MYSQL_PASSWORD=password \
  -e MYSQL_DATABASE=wordpress -e MYSQL_ROOT_PASSWORD=password \
  --detach mariadb:10.5.5
```

### Start wordpress

```bash
podman run --name wordpress --pod wordpress-pod \
  -e WORDPRESS_DB_HOST=127.0.0.1:3306 \
  -e WORDPRESS_DB_USER=wpsuser -e WORDPRESS_DB_PASSWORD=password \
  -e WORDPRESS_DB_NAME=wordpress \
  --detach wordpress:latest
```
